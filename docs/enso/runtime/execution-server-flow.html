<!DOCTYPE HTML>
<html lang="en" >
    <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Execution Server Flow · Enso Developer Documentation</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="The developer documentation for the Enso compiler, runtime, and IDE..
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="Enso.org"><link rel="stylesheet" href="/gitbook/style.css">
<link rel="stylesheet" href="/gitbook/gitbook-plugin-fontsettings/website.css">
<!-- <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css"> -->

<link rel="stylesheet" href="/gitbook/rouge-highlight-colorful.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/gitbook/images/favicon.ico" type="image/x-icon">
        

        
        


        
        
        

        
        
        

        
            <link rel="prev" href="/docs/enso/runtime/unbounded-recursion.html" />
        

        
            <link rel="next" href="/docs/enso/runtime/builtin-base-methods.html" />
        
    </head>
    <body>
        
        <div class="book"><div class="book-summary">
    <div id="search-searchbar">
    </div>
    <div class="post-list" id="search-hits">
        
      </div>
      <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

<script>
var search = instantsearch({
  appId: '3PBI3MMCBE',
  apiKey: '55d673c313b717b7386df8c9418588d4',
  indexName: 'jekyll',
  searchFunction(helper) {
    var container = document.querySelector('#search-hits');
    container.style.display = helper.state.query === '' ? 'none' : '';

    helper.search();
  }
});

var hitTemplate = function(hit) {
  let date = '';
  if (hit.date) {
    date = moment.unix(hit.date).format('MMM D, YYYY');
  }

  let url = `${hit.url}#${hit.anchor}`;

  var title = hit._highlightResult.title.value;

  var content = hit._highlightResult.html.value;

  return `
    <li class="post-item chapter">
      <a href="${url}" class="post-link">${title}</a>
      <div class="post-snippet">${content}</div>
    </li>
  `;
}


search.addWidget(
  instantsearch.widgets.searchBox({
    container: '#search-searchbar',
    placeholder: 'Search the docs',
    poweredBy: true // This is required if you're on the free Community plan
  })
);

search.addWidget(
  instantsearch.widgets.hits({
    container: '#search-hits',
    templates: {
      item: hitTemplate
    }
  })
);

search.start();
</script>

<style>
.ais-search-box {
  max-width: 100%;
  margin-bottom: 15px;
}
.post-item {
  margin-bottom: 30px;
}
.post-link .ais-Highlight {
  color: #111;
  font-style: normal;
  text-decoration: underline;
}
.post-breadcrumbs {
  color: #424242;
  display: block;
}
.post-breadcrumb {
  font-size: 18px;
  color: #424242;
}
.post-breadcrumb .ais-Highlight {
  font-weight: bold;
  font-style: normal;
}
.post-snippet .ais-Highlight {
  color: #2a7ae2;
  font-style: normal;
  font-weight: bold;
}
.post-snippet img {
  display: none;
}

.post-list {
    list-style:none;
    margin:0;
    padding: 10px 15px;
    -webkit-transition:top .5s ease;
    -moz-transition:top .5s ease;
    -o-transition:top .5s ease;
    transition:top .5s ease
}

#search-hits::after {
    content: '';
    display: block;
    height: 1px;
    margin: 7px 0;
    overflow: hidden;
    background: rgba(0,0,0,.07);
}
</style>
    <nav role="navigation">
        <ul class="summary">
            
            <li class="chapter" data-level="1.1" data-path="/">
            
                <a href="/">
                    Home
                </a>
            </li>

            <li class="divider"></li>
            
            
            
            
            

            
            
        
            
            <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime ">
                    <a href="/docs/enso/runtime">
                        Go back
                    </a>
                </li>
                <li class="divider"></li>
            
                
             
            
            
            
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime/">
                    
                        <a href="/docs/enso/runtime/">
                            
                                Enso Runtime
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime/caching.html">
                    
                        <a href="/docs/enso/runtime/caching.html">
                            
                                Caching
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime/demand-analysis.html">
                    
                        <a href="/docs/enso/runtime/demand-analysis.html">
                            
                                Demand Analysis
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime/function-call-flow.html">
                    
                        <a href="/docs/enso/runtime/function-call-flow.html">
                            
                                Function Calling Flow
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime/runtime-features.html">
                    
                        <a href="/docs/enso/runtime/runtime-features.html">
                            
                                Runtime Features
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime/unbounded-recursion.html">
                    
                        <a href="/docs/enso/runtime/unbounded-recursion.html">
                            
                                Unbounded Recursion
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter active" data-level="1.2" data-path="/docs/enso/runtime/execution-server-flow.html">
                    
                        <a href="/docs/enso/runtime/execution-server-flow.html">
                            
                                Execution Server Flow
                            
                        </a>
                    </li>
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime/instruments.html">
                    
                        <a href="/docs/enso/runtime/instruments.html">
                            
                                Instruments
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime/builtin-base-methods.html">
                    
                        <a href="/docs/enso/runtime/builtin-base-methods.html">
                            
                                Builtin Base Methods
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/enso/runtime/searcher.html">
                    
                        <a href="/docs/enso/runtime/searcher.html">
                            
                                Searcher
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            

            
        
        </ul>
    </nav>
</div>
<div class="book-body"><div class="body-inner">
    <div class="book-header" role="navigation">
        <!-- Title -->
        <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i>
            
                <a href="." >Execution Server Flow</a>
            
        </h1>
    </div>
    <div class="page-wrapper" tabindex="-1" role="main">
        <div class="page-inner">
            <div id="book-search-results">
                <div class="search-noresults">
                    <section class="normal markdown-section">
                        <h1 id="execution-server-flow">Execution Server Flow</h1>

<p>This document describes the API and workflow of the internal execution server.</p>

<!-- MarkdownTOC levels="2,3" autolink="true" -->

<ul>
  <li><a href="#opening-a-connection">Opening a Connection</a></li>
  <li><a href="#api">API</a></li>
  <li><a href="#internal-architecture">Internal Architecture</a>
    <ul>
      <li><a href="#job-queue">Job Queue</a></li>
      <li><a href="#job-types">Job Types</a></li>
      <li><a href="#scheduling-rules">Scheduling Rules</a></li>
      <li><a href="#api-methods-to-jobs-translation">API Methods to Jobs Translation</a></li>
    </ul>
  </li>
</ul>

<!-- /MarkdownTOC -->

<h2 id="opening-a-connection">Opening a Connection</h2>

<blockquote>
  <p>The actionables for this section are:</p>

  <ol>
    <li>describe the <code class="language-plaintext highlighter-rouge">org.graalvm.polyglot.Context.Builder.serverTransport</code>
workflow of connecting to the server.</li>
  </ol>
</blockquote>

<h2 id="api">API</h2>

<blockquote>
  <p>The actionables for this section are:</p>

  <ol>
    <li>Document the server’s API.</li>
  </ol>
</blockquote>

<h2 id="internal-architecture">Internal Architecture</h2>

<p>This section describes certain implementation details of the execution server,
allowing it to perform its operations safely and interactively.</p>

<h3 id="job-queue">Job Queue</h3>

<p>The execution server uses a job queue containing requests to be performed. An
API method may queue multiple jobs.</p>

<h3 id="job-types">Job Types</h3>

<p>There are a number of job types used internally for handling different
scenarios:</p>

<h4 id="ensurecompiled"><code class="language-plaintext highlighter-rouge">EnsureCompiled</code></h4>

<p>Takes a set of module names that must be compiled and ensures that the
corresponding modules are compiled in the newest version. It also performs cache
invalidations on changes since the last batch. Caches should be invalidated for
all contexts affected by this recompilation. This operation is idempotent and
should be run before any <code class="language-plaintext highlighter-rouge">Execute</code> action. This operation is not currently
interruptible, but may become so in the future.</p>

<h4 id="execute"><code class="language-plaintext highlighter-rouge">Execute</code></h4>

<p>Takes a context ID and an optional set of expression IDs that should be
executed. and executes the Enso code corresponding to the context’s stack.
Updates caches and sends updates to the users.</p>

<p>This operation is interruptible through <code class="language-plaintext highlighter-rouge">Thread.interrupt()</code>.</p>

<h3 id="scheduling-rules">Scheduling Rules</h3>

<ol>
  <li><code class="language-plaintext highlighter-rouge">EnsureCompiled</code> jobs must be run sequentially (i.e. no other state
modifications or executions are allowed during this job’s run).</li>
  <li><code class="language-plaintext highlighter-rouge">Execute</code> jobs may be run in parallel with each other (but not with
<code class="language-plaintext highlighter-rouge">EnsureCompiled</code> jobs).</li>
  <li><code class="language-plaintext highlighter-rouge">EnsureCompiled</code> jobs may be collapsed into one, by unifying their module
sets.</li>
  <li><code class="language-plaintext highlighter-rouge">Execute</code> jobs with the same <code class="language-plaintext highlighter-rouge">contextId</code> may be collapsed into one, by
merging their <code class="language-plaintext highlighter-rouge">expression IDs</code> sets.</li>
  <li>All enqueued <code class="language-plaintext highlighter-rouge">EnsureCompiled</code> jobs should run before any <code class="language-plaintext highlighter-rouge">Execute</code> jobs.</li>
  <li>The order of <code class="language-plaintext highlighter-rouge">EnsureCompiled</code> jobs can be freely changed by the compiler.</li>
</ol>

<h3 id="api-methods-to-jobs-translation">API Methods to Jobs Translation</h3>

<p>The following describes handling of API messages through job queue
modifications.</p>

<ol>
  <li>EditFile:
    <ol>
      <li>Abort and/or dequeue all pending and running messages (if possible).</li>
      <li>Synchronously perform all code updates.</li>
      <li>Enqueue an <code class="language-plaintext highlighter-rouge">EnsureCompiled</code> with all affected files.</li>
      <li>Enqueue an <code class="language-plaintext highlighter-rouge">Execute</code> for each existing context.</li>
    </ol>
  </li>
  <li>Stack Modifications and Recomputes:
    <ol>
      <li>Abort and/or dequeue all pending and running requests relevant to the
affected context.</li>
      <li>Synchronously perform all state updates.</li>
      <li>Respond to the user.</li>
      <li>Enqueue EnsureCompiled for the file at the bottom of the affected
context’s stack.</li>
      <li>Enqueue Execute for the affected context.</li>
    </ol>
  </li>
  <li>Visualization modifications:
    <ol>
      <li>Synchronously perform all state updates.</li>
      <li>Respond to the user.</li>
      <li>Enqueue <code class="language-plaintext highlighter-rouge">EnsureCompiled</code> and <code class="language-plaintext highlighter-rouge">Execute</code> for the affected context. Set the
minimal set of expressions required to compute to
<code class="language-plaintext highlighter-rouge">Set(visualizedExpression)</code> in the <code class="language-plaintext highlighter-rouge">Execute</code> command.</li>
    </ol>
  </li>
  <li>Create/Destroy context:
    <ol>
      <li>Abort any jobs concerning the affected context.</li>
      <li>Perform state updates / cleanups. No jobs to schedule.</li>
    </ol>
  </li>
</ol>

                        
                        
                        <a href="https://github.com/enso-org/enso/blob/main/docs/enso/runtime/execution-server-flow.md">Open this doc on GitHub</a>
                        
                    </section>
                </div>

                 <!--<div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

<script>
var search = instantsearch({
  appId: '3PBI3MMCBE',
  apiKey: '55d673c313b717b7386df8c9418588d4',
  indexName: 'jekyll',
  searchFunction(helper) {
    var container = document.querySelector('#search-hits');
    container.style.display = helper.state.query === '' ? 'none' : '';

    helper.search();
  }
});

var hitTemplate = function(hit) {
  let date = '';
  if (hit.date) {
    date = moment.unix(hit.date).format('MMM D, YYYY');
  }

  let url = `${hit.url}#${hit.anchor}`;

  var title = hit._highlightResult.title.value;

  var content = hit._highlightResult.html.value;

  return `
    <li class="post-item chapter">
      <a href="${url}" class="post-link">${title}</a>
      <div class="post-snippet">${content}</div>
    </li>
  `;
}


search.addWidget(
  instantsearch.widgets.searchBox({
    container: '#search-searchbar',
    placeholder: 'Search the docs',
    poweredBy: true // This is required if you're on the free Community plan
  })
);

search.addWidget(
  instantsearch.widgets.hits({
    container: '#search-hits',
    templates: {
      item: hitTemplate
    }
  })
);

search.start();
</script>

<style>
.ais-search-box {
  max-width: 100%;
  margin-bottom: 15px;
}
.post-item {
  margin-bottom: 30px;
}
.post-link .ais-Highlight {
  color: #111;
  font-style: normal;
  text-decoration: underline;
}
.post-breadcrumbs {
  color: #424242;
  display: block;
}
.post-breadcrumb {
  font-size: 18px;
  color: #424242;
}
.post-breadcrumb .ais-Highlight {
  font-weight: bold;
  font-style: normal;
}
.post-snippet .ais-Highlight {
  color: #2a7ae2;
  font-style: normal;
  font-weight: bold;
}
.post-snippet img {
  display: none;
}

.post-list {
    list-style:none;
    margin:0;
    padding: 10px 15px;
    -webkit-transition:top .5s ease;
    -moz-transition:top .5s ease;
    -o-transition:top .5s ease;
    transition:top .5s ease
}

#search-hits::after {
    content: '';
    display: block;
    height: 1px;
    margin: 7px 0;
    overflow: hidden;
    background: rgba(0,0,0,.07);
}
</style>-->
            </div>
        </div>
    </div>
</div>

                <a href="/docs/enso/runtime/unbounded-recursion.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Unbounded Recursion">
                    <i class="fa fa-angle-left"></i>
                </a>
                

                
                    <a href="/docs/enso/runtime/builtin-base-methods.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Builtin Base Methods">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},
            "sharing": {
                "all": ["facebook", "google", "twitter", "weibo", "instapaper"],
                "facebook": true,
                "google": false,
                "instapaper": false,
                "twitter": true,
                "vk": false,
                "weibo": false
            },
            "theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Enso Developer Documentation",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "docs/enso/runtime/execution-server-flow.md",
        "mtime": "",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2020-07-21 13:00:36 +0000"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="/gitbook/gitbook.js"></script>
<script src="/gitbook/theme.js"></script>

<script src="/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> --></body>
</html>